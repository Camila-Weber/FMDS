tags:
  - name: Books
    description: API para gerenciar livros

paths:
  /books:
    post:
      summary: Cria um novo livro (usa RPC `insert_book_genres`)
      tags: [Books]
      description: >
        Insere um livro e associações de gêneros de forma atômica via função RPC `insert_book_genres`.
        Campos obrigatórios: title, author, genres (array de IDs).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookCreate'
      responses:
        201:
          description: Livro criado com sucesso (retorna o registro criado conforme RPC).
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Book'
        400:
          description: "Campos obrigatórios ausentes: title, author e genres são necessários."
        500:
          description: Erro ao criar livro (erro do RPC ou do servidor)

    get:
      summary: Lista todos os livros
      tags: [Books]
      description: >
        Retorna todos os livros ordenados por id (ascending). Cada livro contém o array `genres`
        já **flattened** como lista de objetos `{ id, name }` (o controller transforma o resultado da relação).
      responses:
        200:
          description: Lista de livros obtida com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Book'
        500:
          description: Erro ao obter livros

  /books/{id}:
    parameters:
      - name: id
        in: path
        required: true
        schema:
          type: integer
        description: ID do livro
    get:
      summary: Retorna um livro por ID
      tags: [Books]
      description: >
        Busca o livro pelo ID usando `book_genres ( genres ( id, name ) )`.
        **Observação:** o resultado vindo direto da query contém a relação `book_genres`
        (cada item com a chave `genres`), sem flatten automático feito pelo controller `getBookById`.
      responses:
        200:
          description: Livro encontrado
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/BookWithBookGenres'
        404:
          description: Livro não encontrado
        500:
          description: Erro ao obter livro

    put:
      summary: Atualiza um livro por ID (usa RPC `update_book_genres`)
      tags: [Books]
      description: >
        Atualiza campos do livro e as associações de gêneros de forma atômica via RPC `update_book_genres`.
        Campos obrigatórios no corpo: title, author e genres (array de IDs).
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookUpdate'
      responses:
        200:
          description: Livro atualizado com sucesso (retorna o registro atualizado conforme RPC)
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Book'
        400:
          description: "Campos obrigatórios ausentes: title, author e genres são necessários."
        404:
          description: Livro não encontrado ou RPC não retornou dados
        500:
          description: Erro ao atualizar livro

    delete:
      summary: Deleta um livro por ID
      tags: [Books]
      description: Remove o livro da tabela `books` por `id`.
      responses:
        200:
          description: Livro deletado com sucesso
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: "Livro deletado com sucesso"
        404:
          description: Livro não encontrado
        500:
          description: Erro ao deletar livro


components:
  schemas:
    Book:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        author:
          type: string
        available:
          type: boolean
        avg_rating:
          type: number
          format: float
        genres:
          type: array
          description: "Array de gêneros **flattened** no formato [{ id, name }]"
          items:
            type: object
            properties:
              id:
                type: integer
              name:
                type: string

    BookWithBookGenres:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        author:
          type: string
        available:
          type: boolean
        avg_rating:
          type: number
          format: float
        book_genres:
          type: array
          description: >
            Estrutura retornada pela query em `getBookById`: cada item tem a chave `genres`
            com o objeto de gênero — ex.: `[ { "genres": { "id": 4, "name": "X" } } ]`.
          items:
            type: object
            properties:
              genres:
                type: object
                properties:
                  id:
                    type: integer
                  name:
                    type: string

    BookCreate:
      type: object
      required:
        - title
        - author
        - genres
      properties:
        title:
          type: string
        author:
          type: string
        genres:
          type: array
          description: "Array de IDs de gêneros (ex.: [4, 6])"
          items:
            type: integer

    BookUpdate:
      type: object
      required:
        - title
        - author
        - genres
      properties:
        title:
          type: string
        author:
          type: string
        genres:
          type: array
          description: "Array de IDs de gêneros (ex.: [4, 6])"
          items:
            type: integer